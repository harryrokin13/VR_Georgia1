<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>VR Literacy App</title>
    <meta name="description" content="VR Literacy App">
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="./dist/aframe-master.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.js'></script>
    <script src="https://unpkg.com/aframe-text-geometry-component@^0.5.0/dist/aframe-text-geometry-component.min.js"></script> 
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.css' rel='stylesheet' />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://aframe.io/releases/0.6.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-animation-component/dist/aframe-animation-component.min.js"></script>
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100; }
    </style>
  </head>
  <body>
    <style>
      .legend {
          background-color: #d3d3d3;
          border-radius: 3px;
          bottom: 30px;
          box-shadow: 0 1px 2px rgba(0,0,0,0.10);
          font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
          padding: 10px;
          position: absolute;
          right: 10px;
          z-index: 1;
      }

      .legend h4 {
          margin: 0 0 10px;
      }

      .legend div span {
          border-radius: 50%;
          display: inline-block;
          height: 10px;
          margin-right: 5px;
          width: 10px;
      }

      .mapboxgl-popup {
          max-width: 400px;
          font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
      }
    </style>
    <div id='map' style="display: none;"></div>

    <a-scene>
      <a-assets>
        <!--<a-asset-item id="why-male-models" src="man/man.dae"></a-asset-item>
        <img id="fall" src="fall.png">-->
        <img id="mozvr" src="./img/mozvr.png">
        <video id="start01" autoplay loop="false" src="Resources/Start.mp4"></video>
      </a-assets>

     <!-- <a-entity id="model" position="0 0 -3">
        <a-animation attribute="rotation" from="0 -30 0" to="0 330 0" dur="15000"
                     easing="linear" repeat="indefinite"></a-animation>
        <a-collada-model position="-.35 0 .55" rotation="0 -20 0" scale="1.5 1.5 1.5"
                         src="#why-male-models"></a-collada-model>
        <a-image src="#shadow2" rotation="-90 0 0" scale="0.5 0.5 0.5"></a-image>
      </a-entity>
-->
      <a-curvedimage id="mozvr-logo" src="#mozvr" radius="7.7" width="13" theta-length="66" height="10"
                     position="0 3.8 -2" opacity="0.9">
        <a-animation attribute="rotation" from="0 10 0" to="0 200 0" delay="500"
                     dur="1000"></a-animation>
      </a-curvedimage>
      <a-curvedimage id="timeline_Insights" radius="7.7" theta-length="60"  height="5"
                     position="0 3 0" scale="1 1 1">
        <a-animation attribute="rotation" from="0 130 0" to="0 150 0" delay="750"
                     dur="1000"></a-animation>
      </a-curvedimage>

     <!-- <a-image id="price" src="#price" width="7" height="3.5" scale="0.2 0.2 0.2">
        <a-animation attribute="position" from="0 2.8 -6" to="2.25 2.8 -6" delay="1000"
                     dur="1000"></a-animation>
      </a-image>

      <a-cylinder id="goggles" color="#101010" height="0.02" radius="0.8">
        <a-animation attribute="rotation" from="-270 0 0" to="-90 0 0" dur="750" delay="1000"
                     fill="both"></a-animation>
        <a-animation attribute="position" from="8 0 -9" to="8 3.5 -9" dur="750" delay="1000"
                     fill="both"></a-animation>
        <a-image src="#goggles" width="2" height="1" rotation="90 0 0" position="0 -.05 0"
                 scale=".4 .4 .4"></a-image>
      </a-cylinder>

      <a-curvedimage id="stereoscopic-fall-collection-text" src="#fall" radius="5.7"
                     theta-length="18" height=".45" position="0 0.9 0" scale=".4 .4 .4">
        <a-animation attribute="rotation" from="0 180 0" to="0 210 0" delay="750"
                     dur="1000"></a-animation>
      </a-curvedimage>

      <a-curvedimage id="shoes" src="#shoes" radius="5.7" theta-length="18" height=".8"
                     position="0 0.9 0" scale=".4 .4 .4">
        <a-animation attribute="rotation" from="0 180 0" to="0 130 0" delay="750"
                     dur="1000"></a-animation>
      </a-curvedimage>-->
      <a-entity>
        <a-cylinder position="0 0 0" radius="4" height="1" side="back" open-ended="true"
                    color="#FFF"></a-cylinder>
      </a-entity>

      <a-sky color="#ECECEC"></a-sky>
      <a-light type="directional" color="#fff" intensity="0.2" position="-1 2 1"></a-light>
      <a-light type="ambient" color="#fff"></a-light>

      <!--New Code-->
     
      <a-entity position="0 0 2">
          <a-camera></a-camera>
      </a-entity>
     
    <!-- Using the asset management system. -->
      <a-video id="video1" class="video" src="#start01" width="6" height="4" position="0 1.5 0"></a-video>
     
      <!--<a-image id="image" width="26" height="20" position="-9 4 -21" src="" ></a-image>-->
      <!--<a-image id="timeline_Insights" width="15" height="15" position="13 6 -20" src="" ></a-image>-->
      
      <a-entity id="2010"
        position="0 0 -3.9"
        text="color: black; align: center; value: 2010; width: 5"
        rotation="0 0 0">
      </a-entity>

      <a-entity id="2011" position="2.34 0 -3.12" text="color: black; align: center; value: 2011; width: 5" rotation="0 -45 0" scale="" visible="">
      </a-entity>

      <a-entity id="2012" position="3.12 0 -2.34" text="color: black; align: center; value: 2012; width: 5" rotation="0 -54 0" scale="" visible="">
      </a-entity>

      <a-entity id="2013" position="3.57 0 -1.56" text="color: black; align: center; value: 2013; width: 5" rotation="0 -63 0" scale="" visible="">
      </a-entity>

      <a-entity id="2014" position="3.82 0 -0.78" text="color: black; align: center; value: 2014; width: 5" rotation="0 -81 0" scale="" visible="">
      </a-entity>

      <a-entity id="2015" position="3.9 0 0" text="color: black; align: center; value: 2015; width: 5" rotation="0 -90 0" scale="" visible="">
      </a-entity>

      <a-entity id="2016" position="3.82 0 0.78" text="color: black; align: center; value: 2016; width: 5" rotation="0 -99 0" scale="" visible="">
      </a-entity>

      <a-entity id="2017" position="3.57 0 1.56" text="color: black; align: center; value: 2017; width: 5" rotation="0 -117 0" scale="" visible="">
      </a-entity>

      <a-entity id="2018" position="3.12 0 2.34" text="color: black; align: center; value: 2018; width: 5" rotation="0 -126 0" scale="" visible="">
      </a-entity>

      <a-entity id="2019" position="2.34 0 3.12" text="color: black; align: center; value: 2019; width: 5" rotation="0 -135 0" scale="" visible="">
      </a-entity>

      <a-entity id="2020"
        position="0 0 3.9"
        text="color: black; align: center; value: 2020; width: 5"
        rotation="0 0 0">
      </a-entity>
    
    </a-scene>
    <script>
    var scene = document.querySelector("a-scene");
    var vid = document.getElementById("start01");

    if (scene.hasLoaded) {
      run();
    } else {
      scene.addEventListener("loaded", run);
    }

    function run () {
        scene.querySelector(".a-enter-vr-button").addEventListener("click", function(e){
            console.log("VR Mode entered");
            this.style.display = "none";
            vid.play();
        }, false);
    }

    mapboxgl.accessToken = 'pk.eyJ1IjoiaGFycnlyb2tpbjEzIiwiYSI6ImNqNzljMG9mcDAwNmsycm10Y2NjM3N1aHoifQ.BRQyZhWWp_bL3G5TYX6I8Q';
    var jsonDatafile = 'Geojson/georgia2010.geo.json';
    var previousyear = jsonDatafile;
    var previousSelectedYear = '2010';
    var firstload = 1;
    var success = false;
    var selectedyear = 2010;

    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/harryrokin13/cj7a7l2ir8tm52rmt25oev61v',
        center: [-83, 33],
        zoom: 4.4,
        minZoom: 4.7
    });
    map.on('load', function () {
        /*var year=document.getElementById(selectedyear);
        var anim=document. createElement('a-animation');
        anim.setAttribute('attribute','scale');
        anim.setAttribute('to','2 2 1');
        var coloranim=document.createElement('a-animation');
        coloranim.setAttribute('attribute','material.color');
        coloranim.setAttribute('to','white');
        year.appendChild(anim);*/
       /// year.appendChild(coloranim);

        var c = document.querySelector('#map canvas');
        var img = c.toDataURL('image/png');
        var texture = document.getElementById('mozvr-logo');
        texture.setAttribute('src', img);
        var yeartexture = document.getElementById('timeline_Insights');
        var yearImageloc = 'Timeline_Images/'+selectedyear+'.jpg';
        yeartexture.setAttribute('src', yearImageloc);
    });

    var video = document.getElementById('start01');
    video.addEventListener('ended', function (evt) { 
        video.parentNode.removeChild(video);
        var videoframe = document.getElementById('video1');
        videoframe.parentNode.removeChild(videoframe);

        console.log("video stopped");
        var counter = 0;
        var i = setInterval(function(){
            //document.getElementById('link1').click();
            //document.querySelector('a-link').navigate('VR-slide/index.html');
            //var currentJsonFile = 'Geojson/georgia'+selectedyear+'.geo.json';
            success = loadMap(selectedyear);
            if(success == true)
            {
                selectedyear +=1;
                counter +=1;
            }
            success = false;
            if(counter === 11) {
                clearInterval(i);
            }
        }, 5000);
    });

    /*$('#dates a').click(function(event){
                event.preventDefault();
                // first vars
                var selectedyear = $(this).text();
                $('#dates a').removeClass('selected');
                $(this).addClass('selected');
                var currentJsonFile = 'Geojson/georgia'+selectedyear.trim()+'.geo.json';
                loadMap(currentJsonFile,selectedyear);
    });*/

    function loadMap(selectedyear){
        console.log("in load map. counter: "+firstload);
        

            //year.appendChild(rotationanim);
            //var coloranim=document.createElement('a-animation');
            //coloranim.setAttribute('attribute','material.color');
            //coloranim.setAttribute('to','white');
            //year.appendChild(anim);
           // year.appendChild(coloranim);
        
        var layer = 'georgia_'+previousSelectedYear;
        if(firstload>1)
        {

           yearAnimation(selectedyear);
           //var year10 = document.getElementById('2014');
//year10.setAttribute('position', '0 0 -3');
//year10.setAttribute('animation', {property: 'position', dur: 1000, easing: 'easeInSine', loop: true, to: '0 0 -3'});
/*
           var animation = document.createElement("a-animation");
      
      animation.setAttribute("attribute","position");
      animation.setAttribute("from","3.9 0 0");
      animation.setAttribute("to","0 0 -3.8)");//{ x: -year19Pos.x, y: 0, z: -year19Pos.z });
      animation.setAttribute("dur","1000");
      animation.setAttribute("delay","500");
      year10.appendChild(animation);*/

            console.log(layer);
            var visibility = map.getLayoutProperty(layer, 'visibility');

            if (visibility === 'visible') 
                map.setLayoutProperty(layer, 'visibility', 'none');
            /*
            var prev = document.getElementById(previousSelectedYear);
            var anim1=document. createElement('a-animation');
            anim1.setAttribute('attribute','scale');
            anim1.setAttribute('to','1 1 1');
            prev.appendChild(anim1);
            var coloranim=document.createElement('a-animation');
            coloranim.setAttribute('attribute','material.color');
            coloranim.setAttribute('to','blue');
            prev.appendChild(coloranim);*/
            
          }
          previousSelectedYear = selectedyear;


            var c = document.querySelector('#map canvas');
            var img = c.toDataURL('image/png');
            var texture = document.getElementById('mozvr-logo');
            texture.setAttribute('src', img);
            var yeartexture = document.getElementById('timeline_Insights');
            var yearImageloc = 'Timeline_Images/'+selectedyear+'.jpg';
            yeartexture.setAttribute('src', yearImageloc);
        
            //document.getElementById('image').appendChild(texture);
            // When a click event occurs on a feature in the states layer, open a popup at the
            // location of the click, with description HTML from its properties.
            /*map.on('click', jsonfile, function (e) {
                new mapboxgl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(e.features[0].properties.name)
                    .addTo(map);
            });

            // Change the cursor to a pointer when the mouse is over the states layer.
            map.on('mouseenter', jsonfile, function () {
                map.getCanvas().style.cursor = 'pointer';
            });

            // Change it back to a pointer when it leaves.
            map.on('mouseleave', jsonfile, function () {
                map.getCanvas().style.cursor = '';
            });*/
            

        //});  

        firstload +=1;
        return true;
    }

    function yearAnimation(currentYear){
      var yearCounter = 2011;
      var year10 = document.getElementById('2010');
      var year19 = document.getElementById('2019');
      var year19Pos = year19.getAttribute('position');
      var year19Rot = year19.getAttribute('rotation');
      var x = -Math.abs(year19Pos.x);
      var z = -Math.abs(year19Pos.z);
      var pos = x+' '+0+' '+z;
      //var yRot = 180+year19Rot.y;
     // var rot = 0+' '+yRot+' '+0;
      
      //year10.setAttribute('rotation', "0 45 0")
      //year10.setAttribute('animation', {property: 'position', dur: 1000, easing: 'easeInSine', to: '-2.34 0 -3.12'});
    
        
        while(yearCounter<=2020)
        {
          //var year=document.getElementById(yearCounter);
          var prevYear = yearCounter-1;
          var temp = document.getElementById(prevYear);
          var currentYearEntity = document.getElementById(yearCounter);

          if (temp.hasLoaded) {
          var tempPos = temp.getAttribute('position');
          var tempRot = temp.getAttribute('rotation');
          } else {
            temp.addEventListener("loaded", function(){
              var tempPos = temp.getAttribute('position');
            var tempRot = temp.getAttribute('rotation');
            });
          }
            if (currentYearEntity.hasLoaded) {
              //currentYearEntity.setAttribute('rotation', { x: 0, y: -tempRot.y, z: 0})
          
            currentYearEntity.setAttribute('rotation', '0 0 0')
            currentYearEntity.setAttribute('animation', {property: 'position', dur: 1000, easing: 'easeInSine', to: tempPos});
            }
        else {
            currentYearEntity.addEventListener("loaded", function(){
              currentYearEntity.setAttribute('rotation', '0 0 0')
            currentYearEntity.setAttribute('animation', {property: 'position', dur: 1000, easing: 'easeInSine', to: tempPos});
            });
          }
/*
          
          currentYearEntity.setAttribute('rotation', { x: 0, y: -tempRot.y, z: 0})
          animation = document.createElement("a-animation");
          animation.setAttribute("attribute","position");
          animation.setAttribute("to",{ x: tempPos.x, y: 0, z: tempPos.z });
          animation.setAttribute("dur","1000");
          animation.setAttribute("repeat","0");
          currentYearEntity.appendChild(animation);*/

          yearCounter +=1;
        }
        if(firstload<3){
          if (year10.hasLoaded) {
            
              year10.setAttribute('rotation', '0 0 0')
          year10.setAttribute('animation', {property: 'position', dur: 1000, easing: 'easeInSine', to: {x: x,y: 0, z:z}});
          //year10.setAttribute('rotation', {x: 0,y: yRot, z:0});
      
        } else {
          year10.addEventListener("loaded", function(){
            year10.setAttribute('animation', {property: 'position', dur: 1000, easing: 'easeInSine', to: {x: x,y: 0, z:z}});
          //year10.setAttribute('rotation', {x: 0,y: yRot, z:0});
          }); 
        }
      }
        /*
        var xPosition = Math.pow(3.9,2)
        var year=document.getElementById(selectedyear);
        var atr = year.getAttribute('position');
            var anim=document.createElement('a-animation');
            //anim.setAttribute('scale', {x: 2, y: 2, z: 2})
           // anim.setAttribute('rotation', {from:"0 100 0", to:"0 180 0", delay:"750", dur:"1000"})
            
            //anim.setAttribute('attribute','scale');
            anim.setAttribute('to','2 2 2');
            anim.setAttribute('attribute','rotation');
            var rotationanim=document.createElement('a-animation');
            rotationanim.setAttribute('attribute','rotation');
            rotationanim.setAttribute('from','0 100 0');
            rotationanim.setAttribute('to','0 180 0');
            rotationanim.setAttribute('delay','750');
            rotationanim.setAttribute('dur','1000');*/

    }
</script>

  </body>
</html>
